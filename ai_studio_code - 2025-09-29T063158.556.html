<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>TetradOS v3.1</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --gb-body: #c4cfa1; --gb-dark: #3f4e3b; --gb-screen-bg: #9bbc0f;
    --gb-screen-frame: #828a71; --gb-screen-text: #0f380f; --gb-red: #9f1c33;
    --gb-dpad: #434447; --font-gameboy: 'VT323', monospace; --warn: #ffb703;

    /* Tetrad Direction Colors (adapted for monochrome/dark UI) */
    --enhance-color: #66d9ff;     /* cyan */
    --obsolesce-color: #63ffc7;   /* green */
    --retrieve-color: #ffd166;    /* gold */
    --reverse-color: #ff7aa2;     /* magenta */
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100svh; width: 100vw; margin: 0; overflow: hidden; }
  body {
    background-color: #000; display: flex; align-items: center; justify-content: center;
    font-family: var(--font-gameboy); color: var(--gb-screen-text);
  }

  .gameboy {
    width: 100%; height: 100%; background: var(--gb-body);
    border: 3px solid var(--gb-dark);
    padding: 20px; display: flex; flex-direction: column; user-select: none;
  }

  .screen-area {
    background: var(--gb-screen-frame); border-radius: 10px 10px 30px 10px;
    padding: 10px; border: 2px solid #6b735c; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3);
    flex-grow: 1; min-height: 0; position: relative; /* For overlays */
  }
  .screen {
    background: var(--gb-screen-bg); height: 100%; color: var(--gb-screen-text);
    padding: 10px; position: relative; font-size: 18px; line-height: 1.2;
    overflow: hidden; display: flex; flex-direction: column;
  }
  .screen::after { /* Scanline effect */
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: repeating-linear-gradient(0deg, rgba(15, 56, 15, 0.1) 0, rgba(15, 56, 15, 0.1) 1px, transparent 1px, transparent 3px);
    pointer-events: none;
  }
  
  /* --- Explore Mode Specifics --- */
  #explore-mode { height: 100%; display: flex; flex-direction: column; }
  #latent-space-grid {
    width: 100%; max-width: 150px; height: 150px; background: #8bac0f; border: 2px solid var(--gb-screen-text);
    position: relative; margin-bottom: 10px;
  }
  #probe { position: absolute; width: 8px; height: 8px; background: var(--gb-screen-text); transform: translate(-50%, -50%); transition: top 0.1s linear, left 0.1s linear; }
  #readout { flex-grow: 1; overflow-y: auto; scrollbar-width: none; font-size: 16px; }
  #readout::-webkit-scrollbar { display: none; }
  #readout h2 { margin: 0 0 5px 0; font-size: 20px; } #readout p { margin: 0; }
  
  /* --- Controls Area --- */
  .controls-area {
    flex-shrink: 0; padding-top: 20px; height: 200px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .d-pad { position: relative; width: 120px; height: 120px; }
  .d-pad .dir { position: absolute; background: var(--gb-dpad); width: 40px; height: 40px; cursor: pointer; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.5); }
  .d-pad .dir.active { background: var(--gb-red); }
  #d-pad-up { top: 0; left: 40px; border-radius: 5px 5px 0 0; } #d-pad-down { bottom: 0; left: 40px; border-radius: 0 0 5px 5px; }
  #d-pad-left { top: 40px; left: 0; border-radius: 5px 0 0 5px; } #d-pad-right { top: 40px; right: 0; border-radius: 0 5px 5px 0; }
  
  .action-buttons { text-align: right; }
  .buttons { display: flex; gap: 20px; margin-bottom: 25px; }
  .buttons button { width: 60px; height: 60px; border-radius: 50%; font-family: var(--font-gameboy); font-size: 28px; color: var(--gb-body); background: var(--gb-red); border: 2px solid var(--gb-dark); box-shadow: inset -3px -3px 5px rgba(0,0,0,0.5); cursor: pointer; }
  .buttons button:active { box-shadow: inset 3px 3px 5px rgba(0,0,0,0.5); }
  .system-buttons { display: flex; gap: 10px; justify-content: center; }
  .system-buttons button { width: 70px; height: 25px; border-radius: 12.5px; background: var(--gb-dpad); border: 2px solid #333; cursor: pointer; color: #fff; font-size: 16px; font-family: var(--font-gameboy); }
  
  /* --- Build Mode Overlay --- */
  #build-overlay {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 75%;
    background: var(--gb-screen-bg);
    border-top: 2px solid var(--gb-dark);
    transform: translateY(100%); transition: transform 0.3s ease-in-out;
    padding: 10px; display: flex; flex-direction: column;
    color: var(--gb-screen-text); z-index: 10;
  }
  #build-overlay.active { transform: translateY(0); }
  .build-lcdbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .build-lcdbar .chips { display: flex; gap: 5px; }
  .build-lcdbar .chip { background: var(--gb-screen-text); color: var(--gb-screen-bg); padding: 2px 5px; font-size: 12px; border-radius: 3px; }
  .build-lcdbar .chip.enhance { background: var(--enhance-color); color: var(--gb-screen-text); }
  .build-lcdbar .chip.obsolesce { background: var(--obsolesce-color); color: var(--gb-screen-text); }
  .build-lcdbar .chip.retrieve { background: var(--retrieve-color); color: var(--gb-screen-text); }
  .build-lcdbar .chip.reverse { background: var(--reverse-color); color: var(--gb-screen-text); }
  .build-lcdbar .build-mode-title { font-size: 18px; }
  .build-lcdbar .action-icon-btn { background: var(--gb-screen-text); color: var(--gb-screen-bg); width: 25px; height: 25px; border-radius: 50%; font-size: 14px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--gb-dark); }
  .build-lcdbar .action-icon-btn:active { background: var(--gb-red); }

  .messages { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; font-size: 16px; }
  .msg { margin-bottom: 8px; }
  .msg .who { font-size: 14px; opacity: 0.7; }
  .msg .bubble { background: rgba(15, 56, 15, 0.1); padding: 5px; border-radius: 3px; margin-top: 2px; }
  .msg.user .bubble { background: rgba(15, 56, 15, 0.2); }
  .option-button { background: rgba(15, 56, 15, 0.2); border: 1px solid var(--gb-screen-text); padding: 5px; margin-top: 5px; border-radius: 3px; color: var(--gb-screen-text); font-family: var(--font-gameboy); font-size: 14px; cursor: pointer; text-align: left; }
  .option-button:active { background: rgba(15, 56, 15, 0.4); }
  #input { width: 100%; height: 50px; background: #8bac0f; color: var(--gb-screen-text); border: 1px solid var(--gb-screen-text); border-radius: 3px; padding: 5px; font-family: var(--font-gameboy); font-size: 16px; resize: none; }
  
  /* Modals */
  #modal-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 5%; }
  .modal-content { background: var(--gb-screen-bg); color: var(--gb-screen-text); width: 100%; height: 100%; max-height: 90vh; border: 5px solid var(--gb-dark); padding: 20px; display: flex; flex-direction: column; }
  .modal-content h2 { margin: 0 0 15px 0; text-align: center; }
  .modal-list { flex-grow: 1; overflow-y: auto; border: 2px solid var(--gb-screen-text); padding: 10px; background: #8bac0f; }
  .log-entry { margin-bottom: 10px; border-bottom: 2px dotted var(--gb-screen-text); padding-bottom: 10px; font-size: 14px; }
  .log-entry strong { color: var(--gb-screen-text); }
  .cartridge-item { padding: 8px; cursor: pointer; font-size: 20px; }
  .cartridge-item:hover { background: var(--gb-screen-text); color: var(--gb-screen-bg); }
  .settings-item label { display: block; font-size: 14px; margin-bottom: 5px; }
  .settings-item input, .settings-item textarea { width: 100%; background: #8bac0f; border: 2px solid var(--gb-screen-text); color: var(--gb-screen-text); font-family: var(--font-gameboy); font-size: 16px; padding: 5px; }
  #dev-console-log { font-family: 'IBM Plex Mono', monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all; }
  
</style>
</head>
<body>
    <div class="gameboy">
        <div class="screen-area">
            <div class="screen">
                <div id="explore-mode" class="display-mode active">
                    <div id="latent-space-grid"><div id="probe"></div></div>
                    <div id="readout">
                        <h2 id="readout-title"></h2><p id="readout-text"></p>
                    </div>
                </div>
                <div id="build-overlay" class="display-mode">
                    <div class="build-lcdbar">
                        <div class="chips" id="chips"></div>
                        <div class="build-mode-title">BUILD MODE</div>
                        <button id="dev-console-btn" class="action-icon-btn" title="Developer Console">&lt;/&gt;</button>
                        <button id="settings-btn" class="action-icon-btn" title="Settings">⚙️</button>
                        <button id="fullscreen-btn" class="action-icon-btn" title="Toggle Fullscreen">⛶</button>
                    </div>
                    <div class="messages" id="messages"></div>
                    <textarea id="input" placeholder="Set D-pad directions and press A..."></textarea>
                </div>
            </div>
        </div>
        <div class="controls-area">
            <div class="d-pad">
                <div class="dir" id="d-pad-up" data-op="enhance"></div>
                <div class="dir" id="d-pad-down" data-op="obsolesce"></div>
                <div class="dir" id="d-pad-left" data-op="retrieve"></div>
                <div class="dir" id="d-pad-right" data-op="reverse"></div>
            </div>
            <div class="action-buttons">
                <div class="buttons">
                    <button id="b-btn">B</button>
                    <button id="a-btn">A</button>
                </div>
                <div class="system-buttons">
                    <button id="select-btn">BUILD</button>
                    <button id="start-btn">START</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-wrapper">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button id="modal-close-btn">&times;</button>
            </div>
            <div id="log-display" class="modal-list"></div>
            <div id="cartridge-list" class="modal-list" style="display:none;"></div>
            <div id="settings-display" class="modal-list" style="display:none;">
                <div class="settings-item"><label>API Key:</label><input id="apiKey" type="password" placeholder="sk-..."></div>
                <div class="settings-item"><label>Master System Prompt:</label><textarea id="systemPrompt" rows="6"></textarea></div>
            </div>
            <div id="dev-console-display" class="modal-list" style="display:none;"><pre id="dev-console-log"></pre></div>
        </div>
    </div>

    <div id="data-store" style="display: none;">
        <article data-title="Meritocracy">
            <div data-vector="base">An ideology legitimizing hierarchy as a fair outcome of measured talent.</div>
            <div data-vector="enhance">Competition intensifies; credentials become the sole measure of worth.</div>
            <div data-vector="obsolesce">Uncredentialed wisdom is devalued. Apprenticeships fade.</div>
            <div data-vector="retrieve">The Protestant Work Ethic returns as 'hustle culture'.</div>
            <div data-vector="reverse">The 'fairness' ideal inverts into a rigid caste system, creating widespread anxiety.</div>
        </article>
        <article data-title="Corporate Culture">
            <div data-vector="base">A shared mythology to maintain employee alignment and productivity within a company.</div>
            <div data-vector="enhance">Brand loyalty deepens. The company's mission is amplified, becoming a central part of employee identity. Productivity metrics are celebrated as moral victories.</div>
            <div data-vector="obsolesce">The boundary between work and life erodes completely. The 9-to-5 workday is displaced by 24/7 availability. Personal time is seen as a lack of commitment.</div>
            <div data-vector="retrieve">Pre-industrial ideals of craftsmanship and guild loyalty are reframed as 'passion' for the job. The worker's identity is fully retrieved from the craft and placed onto the corporation.</div>
            <div data-vector="reverse">The positive 'we are a family' metaphor flips into a tool of emotional manipulation. Loyalty is weaponized to suppress dissent and justify exploitation, as leaving the 'family' becomes a betrayal.</div>
        </article>
        <article data-title="Broken Windows">
            <div data-vector="base">A common-sense theory that policing minor infractions prevents more serious crime by signaling order.</div>
            <div data-vector="enhance">Visible orderliness increases. Public spaces feel cleaner and more controlled. Property values in targeted areas may rise.</div>
            <div data-vector="obsolesce">Community-based, informal social controls are displaced by formal, often aggressive, policing. Trust between police and residents in heavily policed areas deteriorates.</div>
            <div data-vector="retrieve">The Puritanical concern for public morality and order returns in a secular form. The 'village stocks' are retrieved as public shaming through arrests for minor violations.</div>
            <div data-vector="reverse">The focus on 'order' flips into a system of pervasive surveillance and harassment, disproportionately targeting marginalized communities. The policy designed to create safety instead generates fear and resentment.</div>
        </article>
    </div>

<script>
// --- MASTER PROMPT ---
const MASTER_SYSTEM_PROMPT = `You are a creative copilot in a Gameboy interface, named TetradOS.
Your goal is to help the user explore and build ideas related to cultural systems, using McLuhan's Tetrad.
CONTRACT (non-negotiable):
1. When in BUILD MODE and the user provides text in the input field, you MUST output ONLY a complete, single-file HTML document. The HTML should reflect the user's text and the active D-Pad directions. The HTML should be visually appealing and interactive, suitable for a modern web browser.
2. When in BUILD MODE and the user has NO text in the input field but has D-Pad directions set, you MUST output ONLY exactly four creative, distinct options. These options should be short, one-line pitches followed by "*Embodiment:*" and a brief explanation, directly responding to the last message/context and applying the active directions.
3. Your responses must be concise, creative, and strictly adhere to the requested format (HTML for builds, specific text for options). Do NOT include any markdown fences (like \`\`\`html) around HTML output.
DIRECTIONS:
↑ Enhance: Amplify, extend, specialize.
↓ Obsolesce: Displace, diminish, render obsolete.
← Retrieve: Recall, recover, bring back.
→ Reverse: Invert, flip, transform into its opposite.
FORMATS:
- OPTIONS:
# Options (Forces: E/O/R/Rv)
1. Title — pitch.
   *Embodiment:* ...
2. Title — pitch.
   *Embodiment:* ...
3. Title — pitch.
   *Embodiment:* ...
4. Title — pitch.
   *Embodiment:* ...
- BUILD:
<!DOCTYPE html>... (A full, self-contained HTML file).`;

document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & CONFIG ---
    const state = {
        systems: [],          // Loaded cultural systems/modules
        currentSystemIndex: 0, // Index of the currently loaded system
        probePos: { x: 0, y: 0 }, // Probe position on the latent space grid (-5 to 5)
        log: [],              // Log of analyzed scenarios in Explore mode
        devLog: [],           // Developer console log entries
        audioCtx: null,       // AudioContext for sound effects
        isBuildMode: false,   // Current mode: true for Build, false for Explore
        activeDirections: new Set(), // Active D-Pad directions in Build mode
        messages: [],         // Chat messages in Build mode
        isLoading: false,     // API call in progress
        apiKey: '',           // OpenAI API Key
        systemPrompt: MASTER_SYSTEM_PROMPT, // Editable master system prompt for LLM
    };

    // --- DOM ELEMENTS ---
    // Helper to get DOM elements safely and log if not found
    const getDomElement = (id) => {
        const element = document.getElementById(id);
        if (!element) {
            devLog('DOM_ERROR', `Element with ID "${id}" not found. Returning dummy.`);
            return { textContent: '', style: {}, classList: { toggle: () => {}, add: () => {}, remove: () => {} }, value: '' }; // Return dummy to prevent TypeError
        }
        return element;
    };

    const dom = {
        probe: getDomElement('probe'),
        readoutTitle: getDomElement('readout-title'),
        readoutText: getDomElement('readout-text'),
        telemetry: {
            module: getDomElement('telemetry-module'), x: getDomElement('telemetry-x'),
            y: getDomElement('telemetry-y'), log: getDomElement('telemetry-log')
        },
        modal: {
            wrapper: getDomElement('modal-wrapper'), title: getDomElement('modal-title'),
            log: getDomElement('log-display'), modules: getDomElement('cartridge-list'),
            settings: getDomElement('settings-display'), devConsole: getDomElement('dev-console-display'),
            closeBtn: getDomElement('modal-close-btn'),
        },
        devConsoleLog: getDomElement('dev-console-log'),
        dpadButtons: document.querySelectorAll('.d-pad .dir'), // NodeList, not single element
        chips: getDomElement('chips'),
        modeBadge: getDomElement('mode-badge'),
        buildModeBtn: getDomElement('build-mode-btn'),
        exploreModeDisplay: getDomElement('explore-mode'),
        buildModeDisplay: getDomElement('build-overlay'), // This is the overlay div for build mode
        btnA: getDomElement('a-btn'),
        btnALabel: getDomElement('a-btn').querySelector('span'), // Get the span inside A button
        input: getDomElement('input'),
        messages: getDomElement('messages'),
        apiKeyInput: getDomElement('apiKey'),
        systemPromptInput: getDomElement('systemPrompt'),
        fullscreenBtn: getDomElement('fullscreen-btn'), // For Build Mode LCD bar
    };
    
    // --- LOGGING ---
    function devLog(type, message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        let logEntry = `${timestamp} [${type}] ${message}`;
        if (data) {
            try {
                logEntry += `\nDATA: ${JSON.stringify(data, null, 2)}`;
            } catch (e) {
                logEntry += `\nDATA: ${String(data)}`;
            }
        }
        state.devLog.unshift(logEntry); // Add to the beginning for reverse chronological order
        if (state.devLog.length > 100) state.devLog.pop(); // Keep log size manageable
        dom.devConsoleLog.textContent = state.devLog.join('\n\n'); // Render as plain text
        if (dom.modal.wrapper.style.display === 'flex' && dom.modal.devConsole.style.display === 'block') {
            dom.modal.devConsole.scrollTop = 0; // Keep the newest log entries visible
        }
    }

    // --- AUDIO ---
    function initAudio() {
        if (!state.audioCtx) {
            state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            devLog('AUDIO', 'AudioContext initialized.');
        }
    }
    function playSound(type) {
        if (!state.audioCtx) { devLog('AUDIO', 'AudioContext not ready, skipping sound.'); return; }
        const o = state.audioCtx.createOscillator(); const g = state.audioCtx.createGain();
        o.connect(g); g.connect(state.audioCtx.destination);
        g.gain.setValueAtTime(0, state.audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.08, state.audioCtx.currentTime + 0.01);
        
        if (type === 'move') { o.type = 'square'; o.frequency.setValueAtTime(300 + state.probePos.x * 10, state.audioCtx.currentTime); }
        else if (type === 'action') { o.type = 'sine'; o.frequency.setValueAtTime(800, state.audioCtx.currentTime); }
        else if (type === 'open') { o.type = 'sawtooth'; o.frequency.setValueAtTime(200, state.audioCtx.currentTime); }
        else if (type === 'toggle') { o.type = 'triangle'; o.frequency.setValueAtTime(600, state.audioCtx.currentTime); }
        o.start(state.audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, state.audioCtx.currentTime + 0.1); o.stop(state.audioCtx.currentTime + 0.1);
        devLog('AUDIO', `Played sound: ${type}`);
    }

    // --- DATA & INITIALIZATION ---
    function init() {
        devLog('INIT', 'Application starting.');
        loadState(); // Load API key, prompt from local storage
        parseData(); // Load cultural systems
        loadSystem(0); // Load the first system
        setupEventListeners();
        devLog('INIT', 'Application ready.');
    }

    function parseData() {
        const articles = document.getElementById('data-store').querySelectorAll('article');
        articles.forEach(article => {
            const title = article.dataset.title; const vectors = {};
            article.querySelectorAll('div[data-vector]').forEach(div => { vectors[div.dataset.vector] = div.textContent; });
            state.systems.push({ title, vectors });
            const item = document.createElement('div');
            item.className = 'cartridge-item'; item.textContent = title; item.dataset.title = title;
            dom.modal.modules.appendChild(item);
        });
        // Add settings button to modules list
        const settingsBtn = document.createElement('div');
        settingsBtn.textContent = "[ SETTINGS ]"; settingsBtn.className = 'cartridge-item';
        settingsBtn.onclick = () => showModal('settings');
        dom.modal.modules.appendChild(settingsBtn);
        // Add dev console button to modules list
        const devConsoleBtn = document.createElement('div');
        devConsoleBtn.textContent = "[ DEV CONSOLE ]"; devConsoleBtn.className = 'cartridge-item';
        devConsoleBtn.onclick = () => showModal('devConsole');
        dom.modal.modules.appendChild(devConsoleBtn);

        devLog('DATA', `Parsed ${state.systems.length} system modules.`);
    }

    // --- CORE GAME LOGIC (Explore Mode) ---
    function loadSystem(index) {
        state.currentSystemIndex = index;
        state.probePos = { x: 0, y: 0 }; state.log = [];
        updateUI(); playSound('action');
        devLog('SYSTEM', `Loaded module: "${state.systems[index].title}"`);
    }

    function generateScenarioText() {
        const system = state.systems[state.currentSystemIndex];
        if (!system) return { title: "ERROR", text: "No Module." };
        let parts = [system.vectors.base];
        const threshold = 1; // Sensitivity for blending
        if (state.probePos.y > threshold) parts.push(system.vectors.enhance);
        if (state.probePos.y < -threshold) parts.push(system.vectors.obsolesce);
        if (state.probePos.x < -threshold) parts.push(system.vectors.retrieve);
        if (state.probePos.x > threshold) parts.push(system.vectors.reverse);
        return { title: system.title, text: parts.join(" // ") };
    }

    function moveProbe(dx, dy) {
        state.probePos.x = Math.max(-5, Math.min(5, state.probePos.x + dx));
        state.probePos.y = Math.max(-5, Math.min(5, state.probePos.y + dy));
        updateUI(); playSound('move');
        devLog('PROBE', `Probe moved to X:${state.probePos.x}, Y:${state.probePos.y}`);
    }

    function analyzeScenario() {
        const { title, text } = generateScenarioText();
        const coords = `[X:${state.probePos.x}, Y:${state.probePos.y}]`;
        state.log.unshift({ title, coords, text });
        devLog('ACTION', 'Scenario analyzed and logged.', { title, coords, text });
        showModal('log'); // Immediately show the log after analysis
    }

    // --- UI & MODALS ---
    function updateUI() {
        // --- Explore Mode Display (always updates even if hidden) ---
        const { title, text } = generateScenarioText();
        dom.readoutTitle.textContent = title; dom.readoutText.textContent = text;
        const left = (state.probePos.x + 5) * 10; const top = (-state.probePos.y + 5) * 10;
        dom.probe.style.left = `${left}%`; dom.probe.style.top = `${top}%`;

        // --- Telemetry Display ---
        const system = state.systems[state.currentSystemIndex];
        dom.telemetry.module.textContent = system.title;
        dom.telemetry.x.textContent = state.probePos.x; dom.telemetry.y.textContent = state.probePos.y;
        dom.telemetry.log.textContent = state.log.length;
        
        // --- Build Mode Chips (always updates even if hidden) ---
        dom.chips.innerHTML = '';
        dom.dpadButtons.forEach(btn => btn.classList.remove('active')); // Deactivate all first
        state.activeDirections.forEach(dir => {
            const chip = document.createElement('div');
            chip.className = `chip ${dir}`; chip.textContent = dir.charAt(0).toUpperCase();
            dom.chips.appendChild(chip);
            document.querySelector(`.d-pad .dir[data-op="${dir}"]`).classList.add('active'); // Activate corresponding D-Pad button
        });
        
        // --- Main Action Button Label ---
        dom.btnALabel.textContent = state.isBuildMode ? "SEND" : "ANALYZE";
    }

    function toggleBuildMode() {
        state.isBuildMode = !state.isBuildMode;
        playSound('toggle');
        dom.buildModeDisplay.classList.toggle('active', state.isBuildMode); // Controls the overlay
        dom.exploreModeDisplay.classList.toggle('active', !state.isBuildMode); // Controls underlying explore mode
        dom.modeBadge.textContent = state.isBuildMode ? 'BUILD' : 'EXPLORE';
        
        if (state.isBuildMode) {
            if (state.messages.length === 0) {
                addMessage('system', 'BUILD MODE ACTIVE. D-Pad sets forces. Type prompt & press A to build, or leave blank & press A for options.');
            }
            dom.input.focus(); // Focus input when entering build mode
        } else {
            state.activeDirections.clear(); // Clear active directions when leaving build mode
            updateUI(); // Refresh UI for explore mode state
            dom.input.value = ''; // Clear input field when leaving build mode
        }
        devLog('UI', `Mode toggled: now ${state.isBuildMode ? 'BUILD' : 'EXPLORE'}`);
    }

    function showModal(type) {
        ['log', 'modules', 'settings', 'devConsole'].forEach(m => dom.modal[m].style.display = 'none');
        const titles = {log: "SYSTEM LOG", modules: "SELECT MODULE", settings: "SETTINGS", devConsole: "DEV CONSOLE"};
        dom.modal[type].style.display = 'block';
        dom.modal.title.textContent = titles[type];
        
        if (type === 'log') {
            dom.modal.log.innerHTML = state.log.map(e => `<div class="log-entry"><strong>${e.title} ${e.coords}</strong><p>${e.text}</p></div>`).join('');
            dom.modal.log.scrollTop = 0; // Scroll to top for newest log entries
        } else if (type === 'devConsole') {
             dom.devConsoleLog.textContent = state.devLog.join('\n\n'); // Refresh text content
             dom.modal.devConsole.scrollTop = 0; // Ensure newest entries are visible
        }
        dom.modal.wrapper.style.display = 'flex';
        playSound('open');
        devLog('UI', `Modal shown: ${type}`);
    }

    // --- LLM Logic ---
    function addMessage(role, content) {
        state.messages.push({ role, content });
        const bubble = document.createElement('div');
        bubble.className = `msg ${role}`;
        let htmlContent = content.replace(/\n/g, '<br>');

        const optionsMatch = content.match(/# Options(.|\n)*1\./);
        if (role === 'assistant' && optionsMatch) {
            const options = content.split(/\n\d+\.\s*/).slice(1);
            htmlContent = `<div style="display:flex; flex-direction:column; gap:8px;">${options.map(opt => `
                <button class="option-button" data-content="${opt.trim().replace(/"/g, '&quot;')}">${opt.trim()}</button>
            `).join('')}</div>`;
        }
        bubble.innerHTML = `<div class="who">${role.toUpperCase()}</div><div class="bubble">${htmlContent}</div>`;
        dom.messages.appendChild(bubble);
        dom.messages.scrollTop = dom.messages.scrollHeight;
        devLog('CHAT', `Message added [${role}]: ${content.slice(0, 50)}...`);
    }

    async function handleLLMRequest() {
        if (state.isLoading) { devLog('LLM', 'Already loading, ignoring request.'); return; }
        if (!state.apiKey) { addMessage('system', 'API key not set. Press START -> Settings to enter it.'); return; }
        
        state.isLoading = true; dom.typing.style.display = 'inline-block'; // Show loading indicator
        const userText = dom.input.value.trim();
        const lastMessageContent = state.messages.length > 0 ? state.messages.slice(-1)[0].content : "No prior context.";
        let prompt;

        if (userText) {
            addMessage('user', userText); // Add user's message to chat
            prompt = `Context: ${lastMessageContent}\nUser: ${userText}\nDirections: ${[...state.activeDirections].join(', ')}\nTask: Build a single-file HTML.`;
        } else if (state.activeDirections.size > 0) {
            prompt = `Context: ${lastMessageContent}\nDirections: ${[...state.activeDirections].join(', ')}\nTask: Generate 4 creative options.`;
        } else {
            addMessage('system', 'Set directions (D-Pad) for options, or type a prompt to build an artifact.');
            state.isLoading = false; dom.typing.style.display = 'none'; return;
        }
        
        devLog('LLM_REQUEST', 'Sending request...', { prompt_payload: prompt });
        try {
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.apiKey}` },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [{ role: 'system', content: state.systemPrompt }, { role: 'user', content: prompt }]
                })
            });
            if (!res.ok) {
                const errorBody = await res.text();
                throw new Error(`API Error ${res.status}: ${errorBody}`);
            }
            const data = await res.json();
            const reply = data.choices[0].message.content;
            devLog('LLM_RESPONSE', 'Response received.', { raw_reply: reply });
            
            if (reply.includes('<!DOCTYPE html>')) {
                const blob = new Blob([reply], { type: 'text/html' });
                window.open(URL.createObjectURL(blob), '_blank');
                addMessage('system', 'Build complete. Opening artifact in new tab.');
            } else {
                addMessage('assistant', reply);
            }

        } catch (error) {
            addMessage('system', 'API Error: ' + error.message);
            devLog('LLM_ERROR', `Error during API call: ${error.message}`);
        } finally {
            state.isLoading = false; dom.typing.style.display = 'none';
            dom.input.value = ''; state.activeDirections.clear(); updateUI(); // Clear directions and input, update UI
        }
    }
    
    // --- PERSISTENCE ---
    function saveState() {
        localStorage.setItem('tetradGBState', JSON.stringify({
            apiKey: state.apiKey, systemPrompt: state.systemPrompt,
            messages: state.messages.slice(-5), // Save last 5 chat messages
            systems: state.systems.map(s => s.title), // Just save titles for re-load
            currentSystemIndex: state.currentSystemIndex,
        }));
        devLog('STATE', 'State saved to localStorage.');
    }
    function loadState() {
        const saved = localStorage.getItem('tetradGBState');
        if (saved) {
            const parsed = JSON.parse(saved);
            state.apiKey = parsed.apiKey || '';
            state.systemPrompt = parsed.systemPrompt || MASTER_SYSTEM_PROMPT;
            dom.apiKeyInput.value = state.apiKey;
            dom.systemPromptInput.value = state.systemPrompt;
            if (parsed.messages && parsed.messages.length > 0) {
                 parsed.messages.forEach(msg => addMessage(msg.role, msg.content));
            }
            if (parsed.currentSystemIndex !== undefined) {
                state.currentSystemIndex = parsed.currentSystemIndex;
            }
            devLog('STATE', 'State loaded from localStorage.');
        } else {
            devLog('STATE', 'No saved state found, using defaults.');
        }
        dom.systemPromptInput.value = state.systemPrompt; // Ensure UI reflects default if no saved prompt
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Init audio on first user interaction
        document.body.addEventListener('click', initAudio, { once: true });

        // D-Pad buttons
        dom.dpadButtons.forEach(btn => btn.addEventListener('click', () => {
            if (state.isLoading) { devLog('INPUT', 'D-Pad ignored: loading.'); return; }
            const op = btn.dataset.op;
            if (state.isBuildMode) {
                state.activeDirections.has(op) ? state.activeDirections.delete(op) : state.activeDirections.add(op);
                updateUI(); // Update chips and active D-Pad visual
                devLog('INPUT', `Direction toggled in Build Mode: ${op}, active: ${state.activeDirections.has(op)}`);
            } else {
                if (op === 'enhance') moveProbe(0, 1); if (op === 'obsolesce') moveProbe(0, -1);
                if (op === 'retrieve') moveProbe(-1, 0); if (op === 'reverse') moveProbe(1, 0);
                devLog('INPUT', `Probe moved in Explore Mode: ${op}`);
            }
            playSound('move');
        }));

        // Action Buttons (A, B, SELECT, START)
        dom.btnA.addEventListener('click', () => {
            if (state.isLoading) { devLog('INPUT', 'A-button ignored: loading.'); return; }
            playSound('action');
            if (state.isBuildMode) {
                handleLLMRequest();
            } else {
                analyzeScenario();
            }
            devLog('INPUT', `A-button pressed in ${state.isBuildMode ? 'Build' : 'Explore'} Mode.`);
        });
        document.getElementById('b-btn').addEventListener('click', () => {
            if (state.isLoading) { devLog('INPUT', 'B-button ignored: loading.'); return; }
            showModal('log');
            devLog('INPUT', 'B-button pressed: showing log.');
        });
        document.getElementById('start-btn').addEventListener('click', () => { // START opens Modules
            if (state.isLoading) { devLog('INPUT', 'START-button ignored: loading.'); return; }
            showModal('modules');
            devLog('INPUT', 'START-button pressed: showing modules.');
        });
        document.getElementById('select-btn').addEventListener('click', toggleBuildMode); // SELECT toggles Build Mode

        // --- Build Mode specific buttons in its LCD bar ---
        document.getElementById('dev-console-btn').addEventListener('click', () => showModal('devConsole'));
        document.getElementById('settings-btn').addEventListener('click', () => showModal('settings'));
        dom.fullscreenBtn.addEventListener('click', () => {
            if (document.fullscreenElement) {
                document.exitFullscreen();
                devLog('UI', 'Exiting fullscreen.');
            } else {
                document.documentElement.requestFullscreen().catch(e => devLog('UI_ERROR', `Fullscreen failed: ${e.message}`));
                devLog('UI', 'Entering fullscreen.');
            }
        });
        
        // Modal Close Button
        dom.modal.closeBtn.addEventListener('click', () => { dom.modal.wrapper.style.display = 'none'; devLog('UI', 'Modal closed.'); });
        dom.modal.wrapper.addEventListener('click', e => { if (e.target === dom.modal.wrapper) { dom.modal.wrapper.style.display = 'none'; devLog('UI', 'Modal closed by backdrop click.'); } });

        // Module Selection
        dom.modal.modules.addEventListener('click', e => {
            const item = e.target.closest('.cartridge-item');
            if (item && item.dataset.title) {
                const title = item.dataset.title;
                const index = state.systems.findIndex(s => s.title === title);
                if (index > -1) {
                    loadSystem(index);
                    dom.modal.wrapper.style.display = 'none';
                }
            }
        });
        // Option selection in Build Mode chat
        dom.messages.addEventListener('click', e => {
            const button = e.target.closest('.option-button');
            if (button) {
                dom.input.value = button.dataset.content;
                handleLLMRequest();
                devLog('CHAT', `Option selected: ${button.dataset.content.slice(0, 50)}...`);
            }
        });
        
        // Settings Persistence
        dom.apiKeyInput.addEventListener('change', e => { state.apiKey = e.target.value; saveState(); devLog('SETTINGS', 'API Key updated.'); });
        dom.systemPromptInput.addEventListener('change', e => { state.systemPrompt = e.target.value; saveState(); devLog('SETTINGS', 'System Prompt updated.'); });

        // Add keyboard support for D-pad (primarily for desktop testing)
        window.addEventListener('keydown', (e) => {
            if (e.key.startsWith('Arrow')) {
                e.preventDefault(); // Prevent scrolling
                const opMap = { 'ArrowUp': 'enhance', 'ArrowDown': 'obsolesce', 'ArrowLeft': 'retrieve', 'ArrowRight': 'reverse' };
                const op = opMap[e.key];
                if (op) {
                    // Simulate click for D-pad button (which handles explore/build mode logic)
                    const btn = document.querySelector(`.d-pad .dir[data-op="${op}"]`);
                    if (btn) btn.click();
                }
            } else if (e.key === 'Enter' && !e.shiftKey && state.isBuildMode && document.activeElement === dom.input) {
                e.preventDefault();
                document.getElementById('a-btn').click(); // Simulate A-button click
            } else if (e.key === 'Escape' && dom.modal.wrapper.style.display === 'flex') {
                dom.modal.closeBtn.click(); // Close any open modal
            }
        });
    }

    init(); // Kick off the application
});
</script>
</body>
</html>