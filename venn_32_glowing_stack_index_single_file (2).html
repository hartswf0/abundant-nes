<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>venn‑32 · Iso Stacks (Mobile-tuned)</title>
<style>
  :root{
    --bg:#070a09; --ink:#eaf2ec; --muted:#aab5ae; --edge:#0f1815;
    --ui:#21ff86; --amber:#ffdca8; --orange:#ffb167; --cyan:#7de3ff; --neutral:#b8c4bd;
    --r:16px; --glow:.9;
    --iso-pitch: 35deg;        /* near-true isometric */
    --yaw: 45deg;              /* camera yaw */
    --pitch: 35deg;            /* camera pitch */
    --camZ: -960px;            /* camera distance */
    --zOffset: 0px;            /* global Z scroll */
    --gapZ: 28px;              /* spacing between cards along Z */
    --stackX: 320px;           /* spacing between stacks along X */
    --scale: 1;                /* overall world scale for mobile fitting */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1600px 900px at 10% -10%,#0e1613 0%,#0a0d0f 45%,#07090a 100%);color:var(--ink);font:400 14px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,"Helvetica Neue",Arial;-webkit-tap-highlight-color: transparent}
  a{color:inherit;text-decoration:none}

  /* ===== Header: ultra-minimal ===== */
  header{position:sticky;top:0;z-index:90;backdrop-filter:saturate(120%) blur(8px);background:rgba(8,12,11,.78);border-bottom:1px solid #12231c}
  .bar{display:flex;align-items:center;justify-content:space-between;padding:.5rem .8rem}
  .brand{font-weight:900;letter-spacing:.2px;font-size:13px;opacity:.9}

  /* ===== Stage: real 3D but reads like 2D; scaled for mobile ===== */
  main{height:100dvh;position:relative;overflow:hidden}
  .stageWrap{position:absolute;inset:0;perspective:1200px;touch-action:none}
  .stage{position:absolute;left:50%;top:56%;transform-style:preserve-3d;will-change:transform;
    transform:translate3d(-50%,-50%,var(--camZ)) rotateX(var(--pitch)) rotateY(var(--yaw)) scale(var(--scale));}
  .floor{position:absolute;left:-2000px;right:-2000px;top:320px;height:1600px;background:radial-gradient(closest-side,rgba(33,255,134,.12),transparent 70%);transform:translateZ(-700px) rotateX(90deg)}

  /* ===== Stacks-as-objects ===== */
  .stackObj{position:absolute;transform-style:preserve-3d;will-change:transform}
  .spine{position:absolute;left:-14px;top:-6px;height:200px;width:12px;border-radius:8px;background:#0e1714;border:1px solid #1b3328;box-shadow:inset -2px 0 0 rgba(255,255,255,.04)}
  .cap{position:absolute;top:-22px;left:-8px;padding:.26rem .56rem;border-radius:10px;border:1px solid #1b352a;background:#0d1613;font:800 11px/1 ui-monospace,Menlo,monospace;color:#b8c4bd;transform:translateZ(60px)}
  .count{opacity:.8;margin-left:.45rem}

  /* Layers inside a stack */
  .layer{position:absolute;width:240px;height:150px;border-radius:var(--r);background:linear-gradient(180deg,#0f1513,#091110);border:1px solid #132219;overflow:hidden;transform-style:preserve-3d;cursor:pointer;will-change:transform,filter;touch-action:manipulation}
  .layer::after{content:"";position:absolute;inset:-30%;filter:blur(calc(20px * var(--glow)));opacity:.5;pointer-events:none}
  .g::after{background:radial-gradient(40% 35% at 50% 40%,rgba(33,255,134,.18),transparent),radial-gradient(65% 55% at 50% 60%,rgba(33,255,134,.12),transparent)}
  .a::after{background:radial-gradient(40% 35% at 50% 40%,rgba(255,220,168,.20),transparent),radial-gradient(65% 55% at 50% 60%,rgba(255,210,140,.14),transparent)}
  .o::after{background:radial-gradient(40% 35% at 50% 40%,rgba(255,177,103,.20),transparent),radial-gradient(65% 55% at 50% 60%,rgba(255,150,80,.16),transparent)}
  .c::after{background:radial-gradient(40% 35% at 50% 40%,rgba(125,227,255,.22),transparent),radial-gradient(65% 55% at 50% 60%,rgba(110,210,250,.16),transparent)}
  .n::after{background:radial-gradient(40% 35% at 50% 40%,rgba(184,196,189,.22),transparent),radial-gradient(65% 55% at 50% 60%,rgba(160,170,166,.16),transparent)}
  .layer .title{position:absolute;left:10px;bottom:10px;font-weight:800;font-size:11px;letter-spacing:.15px;transform:translateZ(30px)}
  .layer .sub{position:absolute;left:10px;bottom:28px;font:800 10px/1 ui-monospace,Menlo,monospace;color:#aab5ae;opacity:.9;transform:translateZ(22px)}

  /* Focus states */
  .stackObj.focus .layer{filter:none}
  .stackObj.dim .layer{filter:grayscale(.85) brightness(.7)}
  .layer.active{outline:1px solid #214233}

  /* ===== Fixed Preview Dock ===== */
  .previewDock{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom,0) + 8px);width:min(1100px,96vw);height:56vh;border-radius:14px;overflow:hidden;border:1px solid #21362c;background:linear-gradient(180deg,#0e1714,#0a1210);box-shadow:0 24px 70px rgba(0,0,0,.45);display:none;z-index:95}
  .previewDock.open{display:block}
  .previewDock header{display:flex;align-items:center;gap:.6rem;padding:.55rem .75rem;border-bottom:1px solid #1b2c23;background:#0f1915}
  .previewDock .ttl{font-weight:800;font-size:12px}
  .previewDock .spacer{flex:1}
  .previewDock .btn{appearance:none;border:1px solid #1b352a;background:#0d1613;color:var(--ink);padding:.38rem .6rem;border-radius:10px;cursor:pointer}
  .previewDock iframe{display:block;width:100%;height:calc(100% - 42px);border:0;background:#000}

  @media (min-width: 900px){ .previewDock{height:62vh} }

  /* ===== Alley menus ===== */
  .alley{position:fixed;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:.6rem;z-index:88}
  .alley.left{left:.6rem}
  .alley.right{right:.6rem}
  .iconBtn{width:48px;height:48px;border-radius:12px;border:1px solid #1b352a;background:#0d1613;display:grid;place-items:center;cursor:pointer}
  .iconBtn svg{width:22px;height:22px}
  .iconBtn.active{background:#113024;border-color:#214233}

  /* ===== Base scrub bar (selected stack) ===== */
  .baseScrub{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom,0) + 60px);z-index:92;display:none;align-items:center;gap:.6rem;background:#0d1613;border:1px solid #163026;border-radius:12px;padding:.45rem .7rem}
  .baseScrub.open{display:flex}
  .baseScrub input{width:min(760px,76vw)}
  .baseScrub .info{font:800 11px/1 ui-monospace,Menlo,monospace;color:#b6c1ba}

  /* ===== Bottom pager (mobile-first) ===== */
  .pager{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom,0) + 12px);z-index:93;display:flex;gap:.6rem}
  .pager .pbtn{min-width:56px;height:44px;border-radius:12px;border:1px solid #1b352a;background:#0d1613;color:var(--ink);font-weight:800}

  /* Footer legend */
  footer{position:fixed;left:0;right:0;bottom:0;padding:.4rem .8rem;display:flex;justify-content:space-between;align-items:center;border-top:1px solid #0f1a15;background:rgba(8,12,11,.7);backdrop-filter:saturate(120%) blur(8px)}
  .legend{font:600 11px/1.2 ui-monospace,Menlo,monospace;color:#b9c3bc}
  .dot{display:inline-block;width:.6em;height:.6em;border-radius:50%;margin-right:.25em}
  .gDot{background:#2bff9a}.aDot{background:#ffdeaf}.oDot{background:#ffb167}.cDot{background:#7de3ff}.nDot{background:#b8c4bd}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">V32 · ISO</div>
    <div style="opacity:.65;font:800 10px/1 ui-monospace,Menlo,monospace">tap stack → fan · tap layer → preview · swipe layer/slider to scrub</div>
  </div>
</header>

<main>
  <div class="stageWrap" id="stageWrap">
    <div class="stage" id="stage">
      <div class="floor" aria-hidden="true"></div>
    </div>
  </div>
</main>

<!-- Left Alley: isometric views -->
<aside class="alley left" aria-label="Isometric Views">
  <button class="iconBtn view" data-yaw="45" title="SE">
    <svg viewBox="0 0 24 24" fill="none" stroke="#9fd9c3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3 9 5-9 5-9-5 9-5Z"/><path d="m3 13 9 5 9-5"/></svg>
  </button>
  <button class="iconBtn view" data-yaw="135" title="NE">
    <svg viewBox="0 0 24 24" fill="none" stroke="#9fd9c3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3 9 5-9 5-9-5 9-5Z"/><path d="m3 13 9 5 9-5"/></svg>
  </button>
  <button class="iconBtn view" data-yaw="225" title="NW">
    <svg viewBox="0 0 24 24" fill="none" stroke="#9fd9c3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3 9 5-9 5-9-5 9-5Z"/><path d="m3 13 9 5 9-5"/></svg>
  </button>
  <button class="iconBtn view" data-yaw="315" title="SW">
    <svg viewBox="0 0 24 24" fill="none" stroke="#9fd9c3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3 9 5-9 5-9-5 9-5Z"/><path d="m3 13 9 5 9-5"/></svg>
  </button>
  <button id="snapBtn" class="iconBtn active" title="Snap ISO">
    <svg viewBox="0 0 24 24" fill="none" stroke="#9fd9c3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 7 7-7 7"/><path d="M14 4h7v7"/></svg>
  </button>
</aside>

<!-- Right Alley: layout & site -->
<aside class="alley right" aria-label="Layout">
  <a class="iconBtn" href="https://hartswf0.github.io/venn-32/" target="_blank" rel="noopener" title="Open Site">
    <svg viewBox="0 0 24 24" fill="none" stroke="#9fd9c3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><path d="m15 3 6 6"/><path d="M21 3v6h-6"/></svg>
  </a>
</aside>

<!-- Fixed preview dock (always same absolute position) -->
<section id="dock" class="previewDock" aria-label="Preview" aria-hidden="true">
  <header>
    <div id="dockTitle" class="ttl"></div>
    <div class="spacer"></div>
    <a id="dockOpen" class="btn" target="_blank" rel="noopener">Open</a>
    <button id="dockClose" class="btn" aria-label="Close">Close</button>
  </header>
  <iframe id="dockFrame" sandbox="allow-scripts allow-forms allow-same-origin allow-pointer-lock" referrerpolicy="no-referrer"></iframe>
</section>

<!-- Base scrub bar (selected stack) + pager -->
<div id="baseScrub" class="baseScrub" aria-label="Stack Scrub">
  <button id="prevBtn" class="pbtn" title="Prev">‹</button>
  <span class="info" id="scrubInfo">—</span>
  <input id="stackRange" type="range" min="0" max="0" step="1" value="0"/>
  <button id="nextBtn" class="pbtn" title="Next">›</button>
</div>

<footer>
  <div class="legend">
    <span><span class="dot gDot"></span>RHM</span>
    <span><span class="dot aDot"></span>Volumetric/Nexus</span>
    <span><span class="dot oDot"></span>VOL Media</span>
    <span><span class="dot cDot"></span>Stack Index</span>
    <span><span class="dot nDot"></span>General</span>
  </div>
  <div></div>
</footer>

<script>
// ===== DATA =====
const DATA={families:[
  {id:'general',label:'General',color:'n',items:[
    {title:'README',file:'README.md'},
    {title:'Index',file:'index.html'},
    {title:'RHM visible layers (data)',file:'RHM_visible_layers.json'}]},
  {id:'rhm',label:'RHM series',color:'g',items:[
    {title:'RHM · 32 Layer Instrument',file:'rhm_32_layer_instrument.html'},
    {title:'RHM · Cards on Face',file:'rhm_cards_on_face.html'},
    {title:'RHM · Cards on Face v3',file:'rhm_cards_on_face_v3.html'},
    {title:'RHM · Cards on Face v4',file:'rhm_cards_on_face_v4.html'},
    {title:'RHM · Cards on Face v4a',file:'rhm_cards_on_face_v4a.html'},
    {title:'RHM · Cards on Face v5',file:'rhm_cards_on_face_v5.html'},
    {title:'RHM · Deck Overlap',file:'rhm_deck_overlap.html'},
    {title:'RHM · DOM v7b',file:'rhm_dom_v7b.html'},
    {title:'RHM · DOM v7c (mobile)',file:'rhm_dom_v7c_mobile.html'},
    {title:'RHM · DOM v7d (mobile pro)',file:'rhm_dom_v7d_mobile_pro.html'},
    {title:'RHM · DOM v7e (mobile cards)',file:'rhm_dom_v7e_mobile_cards.html'},
    {title:'RHM · DOM v7f (fix stacks colors overlay)',file:'rhm_dom_v7f_fix_stacks_colors_overlay.html'},
    {title:'RHM · DOM v7g (auto fit)',file:'rhm_dom_v7g_auto_fit.html'},
    {title:'RHM · DOM v7h (read guaranteed)',file:'rhm_dom_v7h_read_guaranteed.html'},
    {title:'RHM · Faces Reader (orig)',file:'rhm_faces_reader.html'},
    {title:'RHM · Faces Reader (1)',file:'rhm_faces_reader (1).html'},
    {title:'RHM · Faces Reader v2',file:'rhm_faces_reader_v2.html'},
    {title:'RHM · Post-its (orig)',file:'rhm_postits.html'},
    {title:'RHM · Post-its (1)',file:'rhm_postits (1).html'},
    {title:'RHM · Three v9',file:'rhm_three_v9.html'},
    {title:'RHM · Ultralite v8',file:'rhm_ultralite_v8.html'}]},
  {id:'volumetric',label:'Volumetric / Venn / Nexus',color:'a',items:[
    {title:'Volumetric · Cube Stacks Overlap · Nexus (Gully)',file:'volumetric_cube_stacks_overlap_nexus_gully_edition.html'},
    {title:'Volumetric · Cube Stacks Overlap · Nexus (Gully) (1)',file:'volumetric_cube_stacks_overlap_nexus_gully_edition (1).html'},
    {title:'Volumetric · Media Nexus · Unthinkable Applied',file:'volumetric_media_nexus_unthinkable_applied.html'},
    {title:'Volumetric · Media Nexus · Unthinkable Applied (1)',file:'volumetric_media_nexus_unthinkable_applied (1).html'},
    {title:'Volumetric · Media Nexus · Unthinkable Applied (2)',file:'volumetric_media_nexus_unthinkable_applied (2).html'},
    {title:'Volumetric · Media Nexus · Unthinkable Applied (3)',file:'volumetric_media_nexus_unthinkable_applied (3).html'},
    {title:'Volumetric · Media Nexus · Unthinkable Applied (4)',file:'volumetric_media_nexus_unthinkable_applied (4).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock',file:'volumetric_venn_cubes_mobile_draggable_dock.html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (1)',file:'volumetric_venn_cubes_mobile_draggable_dock (1).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (2)',file:'volumetric_venn_cubes_mobile_draggable_dock (2).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (3)',file:'volumetric_venn_cubes_mobile_draggable_dock (3).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (4)',file:'volumetric_venn_cubes_mobile_draggable_dock (4).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (5)',file:'volumetric_venn_cubes_mobile_draggable_dock (5).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (6)',file:'volumetric_venn_cubes_mobile_draggable_dock (6).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (7)',file:'volumetric_venn_cubes_mobile_draggable_dock (7).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (8)',file:'volumetric_venn_cubes_mobile_draggable_dock (8).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (9)',file:'volumetric_venn_cubes_mobile_draggable_dock (9).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (10)',file:'volumetric_venn_cubes_mobile_draggable_dock (10).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (11)',file:'volumetric_venn_cubes_mobile_draggable_dock (11).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (12)',file:'volumetric_venn_cubes_mobile_draggable_dock (12).html'},
    {title:'Volumetric · Venn Cubes · Mobile Draggable Dock (13)',file:'volumetric_venn_cubes_mobile_draggable_dock (13).html'}]},
  {id:'vol_media',label:'VOL Media Decks',color:'o',items:[
    {title:'VOL Media Decks v6',file:'vol_media_decks_v6.html'},
    {title:'VOL Media Decks v7',file:'vol_media_decks_v7.html'},
    {title:'VOL Media Decks v5 · Canvas Only Data Stacks',file:'vol_media_decks_v_5_canvas_only_data_stacks.html'},
    {title:'VOL Media Decks v5 · Canvas Only Data Stacks (1)',file:'vol_media_decks_v_5_canvas_only_data_stacks (1).html'},
    {title:'VOL Media Decks v5 · Canvas Only Data Stacks (2)',file:'vol_media_decks_v_5_canvas_only_data_stacks (2).html'},
    {title:'VOL Media Decks v5 · Canvas Only Data Stacks (3)',file:'vol_media_decks_v_5_canvas_only_data_stacks (3).html'}]},
  {id:'stack_index',label:'Stack Index (Minimal Preview)',color:'c',items:[
    {title:'Stack Index · Minimal Preview',file:'stack_index_minimal_preview_single_file_html.html'},
    {title:'Stack Index · Minimal Preview (1)',file:'stack_index_minimal_preview_single_file_html (1).html'},
    {title:'Stack Index · Minimal Preview (2)',file:'stack_index_minimal_preview_single_file_html (2).html'},
    {title:'Stack Index · Minimal Preview (3)',file:'stack_index_minimal_preview_single_file_html (3).html'},
    {title:'Stack Index · Minimal Preview (4)',file:'stack_index_minimal_preview_single_file_html (4).html'},
    {title:'Stack Index · Minimal Preview (5)',file:'stack_index_minimal_preview_single_file_html (5).html'}]}
]};

const PAGES_BASE='https://hartswf0.github.io/venn-32/';
const SIMPLE='?simple';
function urlFor(file){return PAGES_BASE+encodeURIComponent(file).replace(/%2F/g,'/')+SIMPLE}

// ===== State =====
let snapISO=true;
let stacks=[]; // {dom,fam,x}
let focusedStack=null; // DOM of focused stack
let activeFamily=null, activeIndex=0, activeList=[], activeLayer=null;

// ===== Elements =====
const stage=document.getElementById('stage');
const wrap=document.getElementById('stageWrap');
const dock=document.getElementById('dock');
const dockTitle=document.getElementById('dockTitle');
const dockOpen=document.getElementById('dockOpen');
const dockFrame=document.getElementById('dockFrame');
const baseScrub=document.getElementById('baseScrub');
const stackRange=document.getElementById('stackRange');
const scrubInfo=document.getElementById('scrubInfo');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');

// ===== Fit-to-mobile scale =====
function fitScale(){
  const w = window.innerWidth;
  const target = 320; // approx stack width + margins
  const scale = Math.max(0.75, Math.min(1, (w-24)/target));
  document.documentElement.style.setProperty('--scale', String(scale));
}

// ===== Build Stacks =====
function build(){
  stacks.length=0; stage.querySelectorAll('.stackObj').forEach(n=>n.remove());
  DATA.families.forEach((fam,xi)=>{
    const so=document.createElement('div'); so.className='stackObj';
    const x=(xi-0.5)*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--stackX'));
    so.style.transform=`translate3d(${x}px,0,0)`;

    const spine=document.createElement('div'); spine.className='spine'; so.appendChild(spine);
    const cap=document.createElement('div'); cap.className='cap'; cap.textContent=fam.id.toUpperCase(); const cnt=document.createElement('span'); cnt.className='count'; cnt.textContent=`${fam.items.length}`; cap.appendChild(cnt); so.appendChild(cap);

    fam.items.forEach((it,zi)=>{
      const layer=document.createElement('div'); layer.className=`layer ${fam.color}`; layer.dataset.index=String(zi); layer.dataset.family=fam.id;
      const dz = zi * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gapZ'));
      const dy = -zi * 1.2; // small parallax hint
      layer.style.transform = `translate3d(0px, ${dy}px, ${dz}px)`;
      layer.innerHTML = `<div class="sub">${fam.id}</div><div class="title">${it.title}</div>`;
      layer.addEventListener('click', (e)=>{ e.stopPropagation(); focusStack(so); openDock(fam.id, zi, it.title, urlFor(it.file)); setActiveLayer(layer); });
      so.appendChild(layer);
    });

    so.addEventListener('click', ()=> focusStack(so));
    stage.appendChild(so);
    stacks.push({dom:so, fam, x});
  });
}

function setActiveLayer(lay){ activeLayer?.classList.remove('active'); activeLayer=lay; if(lay){ lay.classList.add('active'); lay.scrollIntoView({behavior:'smooth',block:'center'}); navigator.vibrate?.(8); } }

function focusStack(so){
  focusedStack=so;
  stacks.forEach(s=>{ s.dom.classList.toggle('focus', s.dom===so); s.dom.classList.toggle('dim', s.dom!==so); });
  // tiny fan so it still reads 2D
  const layers=[...so.querySelectorAll('.layer')];
  layers.forEach((layer,i)=>{ const baseZ=i*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gapZ')); const dy=-i*1.2; const spread = 1.5; layer.style.transform = `translate3d(${(i%2?spread:-spread)}px, ${dy}px, ${baseZ}px)`; });
}

// ===== Dock + Base Scrub =====
function openDock(familyId, index, title, url){
  activeFamily=familyId; activeIndex=index; activeList = DATA.families.find(f=>f.id===familyId).items;
  dockTitle.textContent=title; dockOpen.href=url; dockFrame.src=url; dock.classList.add('open'); dock.setAttribute('aria-hidden','false');
  // setup base scrub
  stackRange.min=0; stackRange.max=Math.max(0, activeList.length-1); stackRange.value=String(activeIndex);
  updateScrubInfo(); baseScrub.classList.add('open');
}
function updateScrubInfo(){ scrubInfo.textContent = `${activeFamily.toUpperCase()}  ${activeIndex+1}/${activeList.length}`; }
function closeDock(){ dock.classList.remove('open'); dock.setAttribute('aria-hidden','true'); dockFrame.removeAttribute('src'); baseScrub.classList.remove('open'); setActiveLayer(null); activeFamily=null; }

document.getElementById('dockClose').addEventListener('click', closeDock);

stackRange.addEventListener('input', ()=>{ if(!activeFamily) return; const i=parseInt(stackRange.value); if(Number.isNaN(i)) return; activeIndex=i; const item=activeList[i]; dockTitle.textContent=item.title; const url=urlFor(item.file); dockOpen.href=url; if(dockFrame.src!==url) dockFrame.src=url; updateScrubInfo(); if(focusedStack){ const lay=focusedStack.querySelector(`.layer[data-index="${i}"]`); if(lay) setActiveLayer(lay); } });
prevBtn.addEventListener('click', ()=>{ if(!activeFamily) return; stackRange.value = String(Math.max(0, activeIndex-1)); stackRange.dispatchEvent(new Event('input')); });
nextBtn.addEventListener('click', ()=>{ if(!activeFamily) return; stackRange.value = String(Math.min(activeList.length-1, activeIndex+1)); stackRange.dispatchEvent(new Event('input')); });

// ===== Touch scrubbing on focused stack (vertical) =====
let touchY=null; let scrStart=null;
function attachStackGestures(){
  stage.querySelectorAll('.stackObj').forEach(so=>{
    so.addEventListener('touchstart', (e)=>{ if(e.touches.length!==1) return; if(so!==focusedStack) return; touchY=e.touches[0].clientY; scrStart=activeIndex; }, {passive:true});
    so.addEventListener('touchmove', (e)=>{ if(touchY==null||so!==focusedStack||!activeFamily) return; const dy=e.touches[0].clientY - touchY; const step=Math.round(dy/38); const next=clamp(scrStart - step, 0, activeList.length-1); if(next!==activeIndex){ stackRange.value=String(next); stackRange.dispatchEvent(new Event('input')); } }, {passive:true});
    so.addEventListener('touchend', ()=>{ touchY=null; scrStart=null; }, {passive:true});
  });
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

// ===== Camera & Interaction (mobile-tuned) =====
let dragging=false, lastX=0, lastY=0; let pendingYaw=null, pendingZO=null; let rafId=null;
wrap.addEventListener('pointerdown',e=>{ dragging=true; lastX=e.clientX; lastY=e.clientY; wrap.setPointerCapture(e.pointerId); });
wrap.addEventListener('pointermove',e=>{
  if(!dragging) return; const dx=e.clientX-lastX, dy=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY; queueYawDelta(dx*0.12); queueZDelta(dy*1.5);
});
wrap.addEventListener('pointerup',()=>{ dragging=false; if(snapISO) snapToIso(); });
wrap.addEventListener('wheel',e=>{ e.preventDefault(); queueZDelta(e.deltaY*1.0); }, {passive:false});

function queueYawDelta(d){ pendingYaw=(pendingYaw??0)+d; scheduleTick(); }
function queueZDelta(d){ pendingZO=(pendingZO??0)+d; scheduleTick(); }
function scheduleTick(){ if(rafId) return; rafId=requestAnimationFrame(tick); }
function tick(){ rafId=null; const root=document.documentElement; const yaw=getYaw()+((pendingYaw??0)); const z=getZOffset()+((pendingZO??0)); pendingYaw=null; pendingZO=null; root.style.setProperty('--yaw', yaw+'deg'); root.style.setProperty('--zOffset', z+'px'); }

function getYaw(){ return parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--yaw')); }
function getZOffset(){ return parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--zOffset')); }
function snapToIso(){ const root=document.documentElement; const cur=getYaw(); const targets=[45,135,225,315]; let best=targets[0], diff=1e9; targets.forEach(t=>{ const d=Math.abs(((cur-t+540)%360)-180); if(d<diff){ diff=d; best=t; } }); root.style.setProperty('--yaw', best+'deg'); root.style.setProperty('--pitch', getComputedStyle(root).getPropertyValue('--iso-pitch')); }

// ===== Alley wiring =====
Array.from(document.querySelectorAll('.view')).forEach(btn=> btn.addEventListener('click',()=>{ const yaw=parseFloat(btn.dataset.yaw); document.documentElement.style.setProperty('--yaw', yaw+'deg'); document.documentElement.style.setProperty('--pitch', getComputedStyle(document.documentElement).getPropertyValue('--iso-pitch')); }));
const snapBtn=document.getElementById('snapBtn'); snapBtn.addEventListener('click',()=>{ snapISO=!snapISO; snapBtn.classList.toggle('active', snapISO); if(snapISO) snapToIso(); });

// ===== Init =====
fitScale();
build(); attachStackGestures(); snapToIso();
window.addEventListener('resize', fitScale);
window.addEventListener('orientationchange', ()=>setTimeout(fitScale, 50));

// ===== Tests =====
console.log('[v32-iso-mobile] url test', urlFor('rhm_cards_on_face.html')==='https://hartswf0.github.io/venn-32/rhm_cards_on_face.html?simple');
</script>
</body>
</html>
